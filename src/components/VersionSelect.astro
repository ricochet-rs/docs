---
import { Icon } from "@astrojs/starlight/components";
import starlightConfig from "virtual:starlight/user-config";
// @ts-expect-error - Virtual module provided by starlight-versions Vite plugin at build time
import starlightVersionsConfig from "virtual:starlight-versions-config";

type Version = {
  slug: string;
  label?: string;
  redirect?: "same-page" | "root";
};

function getVersionFromSlug(
  config: typeof starlightVersionsConfig,
  starlightCfg: typeof starlightConfig,
  slug: string,
): Version | undefined {
  const segments = slug.split("/");
  const versionOrLocaleSegment = segments[0];
  if (!versionOrLocaleSegment) return undefined;
  const version = config.versions.find(
    (v: Version) => v.slug === versionOrLocaleSegment,
  );
  if (version) return version;
  const locales = Object.keys(starlightCfg.locales ?? {});
  if (!locales.includes(versionOrLocaleSegment)) return undefined;
  const versionSegment = segments[1];
  return config.versions.find((v: Version) => v.slug === versionSegment);
}

function stripTrailingSlash(path: string): string {
  return path.endsWith("/") ? path.slice(0, -1) : path;
}

function getExtension(path: string): string {
  const match = path.match(/\.[^.]+$/);
  return match ? match[0] : "";
}

function stripExtension(path: string): string {
  return path.replace(/\.[^.]+$/, "");
}

function getVersionURL(
  config: typeof starlightVersionsConfig,
  starlightCfg: typeof starlightConfig,
  url: URL,
  version: Version | undefined,
): URL {
  const versionURL = new URL(url);
  const versionSlug = version?.slug ?? "";
  const versionRedirect = version?.redirect ?? config.current.redirect;

  const base = stripTrailingSlash(import.meta.env.BASE_URL);
  const hasBase = versionURL.pathname.startsWith(base);

  if (hasBase) {
    versionURL.pathname = versionURL.pathname.replace(base, "");
  }

  let baseSegment: string | undefined;
  let localeSegment: string | undefined;

  const isHTML = getExtension(versionURL.pathname) === ".html";
  const [, firstSegment, secondSegment] = versionURL.pathname.split("/");

  if (starlightCfg.isMultilingual || starlightCfg.locales) {
    const versionOrLocale = firstSegment?.replace(".html", "");
    const isRootLocale =
      versionOrLocale &&
      !Object.keys(starlightCfg.locales ?? {}).includes(versionOrLocale);
    baseSegment = isRootLocale ? firstSegment : secondSegment;

    if (!isRootLocale) {
      localeSegment = versionOrLocale;
      versionURL.pathname = versionURL.pathname.replace(`/${firstSegment}`, "");
    }
  } else {
    baseSegment = firstSegment;
  }

  const isRootHTML = baseSegment && getExtension(baseSegment) === ".html";
  const baseSlug =
    baseSegment && isRootHTML ? stripExtension(baseSegment) : baseSegment;

  if (baseSlug && baseSlug in config.versionsBySlug) {
    if (versionSlug) {
      versionURL.pathname =
        versionRedirect === "same-page"
          ? versionURL.pathname.replace(baseSlug, versionSlug)
          : `${versionSlug}${isHTML ? ".html" : "/"}`;
    } else if (isRootHTML) {
      versionURL.pathname = "/index.html";
    } else {
      versionURL.pathname =
        versionRedirect === "same-page"
          ? versionURL.pathname.replace(`/${baseSlug}`, "")
          : isHTML
            ? "/index.html"
            : "/";
    }
  } else if (versionSlug) {
    versionURL.pathname =
      baseSegment === "index.html"
        ? `/${versionSlug}.html`
        : versionRedirect === "same-page"
          ? `/${versionSlug}${versionURL.pathname}`
          : isHTML
            ? `${versionSlug}.html`
            : `/${versionSlug}/`;
  } else if (versionRedirect === "root" && !isRootHTML) {
    versionURL.pathname = isHTML ? "/index.html" : versionSlug;
  }

  if (localeSegment) {
    versionURL.pathname = isHTML
      ? versionURL.pathname === "/index.html"
        ? `/${localeSegment}.html`
        : `/${localeSegment}${versionURL.pathname.replace(/\/$/, ".html")}`
      : `/${localeSegment}${versionURL.pathname}`;
  }

  if (hasBase) {
    versionURL.pathname = base + versionURL.pathname;
  }

  return versionURL;
}

const { id } = Astro.locals.starlightRoute;
const pageVersion = getVersionFromSlug(
  starlightVersionsConfig,
  starlightConfig,
  id,
);
---

<starlight-version-select>
  <label>
    <span class="sr-only">Select version</span>
    <Icon name="open-book" class="icon label-icon" />
    <select
      value={pageVersion?.label ?? starlightVersionsConfig.versions[0]?.label}
      autocomplete="off"
    >
      {
        starlightVersionsConfig.versions
          .filter((version: Version) => version.slug !== "dev")
          .map((version: Version) => (
            <option
              selected={
                version.slug === pageVersion?.slug ||
                (pageVersion === undefined &&
                  version === starlightVersionsConfig.versions[0])
              }
              value={
                getVersionURL(
                  starlightVersionsConfig,
                  starlightConfig,
                  Astro.url,
                  version,
                ).pathname
              }
            >
              {version.label ?? version.slug}
            </option>
          ))
      }
    </select>
    <Icon name="down-caret" class="icon caret-icon" />
  </label>
</starlight-version-select>

<style>
  label {
    --sl-versions-label-icon-size: 0.875rem;
    --sl-versions-caret-icon-size: 1.25rem;

    align-items: center;
    color: var(--sl-color-gray-1);
    display: flex;
    gap: 0.25rem;
    position: relative;
  }

  label:hover {
    color: var(--sl-color-gray-2);
  }

  .icon {
    pointer-events: none;
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
  }

  .label-icon {
    font-size: var(--sl-versions-label-icon-size);
    inset-inline-start: 0;
  }

  .caret-icon {
    font-size: var(--sl-versions-caret-icon-size);
    inset-inline-end: 0;
  }

  select {
    appearance: none;
    background-color: transparent;
    border: 0;
    color: inherit;
    cursor: pointer;
    padding-block: 0.625rem;
    padding-inline: calc(var(--sl-versions-label-icon-size) + 0.375rem)
      calc(var(--sl-versions-caret-icon-size) + 0.25rem);
    text-overflow: ellipsis;
    /* Fixed width to prevent flickering - fits "1.0" and "0.1" */
    width: 4.5rem;
  }

  option {
    background-color: var(--sl-color-bg-nav);
    color: var(--sl-color-gray-1);
  }

  @media (min-width: 50rem) {
    select {
      font-size: var(--sl-text-sm);
    }
  }
</style>

<script>
  customElements.define(
    "starlight-version-select",
    class StarlightVersionSelect extends HTMLElement {
      constructor() {
        super();

        const select = this.querySelector("select");
        if (!select) return;

        select.addEventListener("change", (event) => {
          if (event.currentTarget instanceof HTMLSelectElement) {
            globalThis.location.pathname = event.currentTarget.value;
          }
        });

        window.addEventListener("pageshow", (event) => {
          if (!event.persisted) return;
          const markupSelectedIndex =
            select.querySelector<HTMLOptionElement>("option[selected]")?.index;

          if (markupSelectedIndex !== select.selectedIndex) {
            select.selectedIndex = markupSelectedIndex ?? 0;
          }
        });
      }
    },
  );
</script>
