when:
  - event: push
    branch: ${CI_REPO_DEFAULT_BRANCH}

labels:
  type: static

steps:
  - name: Build
    image: reg.ricochet.rs/docker.io/oven/bun:1.3-alpine
    commands:
      - bun install
      - bun astro build

  # Pre-deploy check validates internal links in dist/ before deployment.
  # Canonical/og:url self-references are excluded via lychee.toml since they
  # point to docs.ricochet.rs which won't have new pages until after deploy.
  - name: Pre-deploy link check
    image: reg.ricochet.rs/docker.io/lycheeverse/lychee:0.22-alpine
    environment:
      GITHUB_TOKEN:
        from_secret: github_token
    commands:
      - lychee dist/ --root-dir dist/ -t 40 --max-redirects 10 --exclude-loopback --insecure --cache --max-cache-age 1d
